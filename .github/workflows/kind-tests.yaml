name: KinD Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  kind-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
      - uses: docker/setup-buildx-action@v3

      - run: |
          # Install KinD
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - run: sudo apt-get update && sudo apt-get install -y jq
      - run: docker build -t snoop:ci-test .

      - name: Set up KinD cluster
        run: |
          cd test/kind
          ./setup.sh snoop:ci-test

      - name: Run KinD integration tests
        run: |
          cd test/kind
          IMAGE_TAG=snoop:ci-test ./run-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kind-test-results
          path: test/kind/results/
          retention-days: 7

      - name: Clean up
        if: always()
        run: |
          kind delete cluster --name snoop-test || true
